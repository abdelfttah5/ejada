<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>استمارة التحويل الذكي لنتائج الزيارة الإشرافية</title>
<style>
:root{
  --bg1:#070A12; --bg2:#0B1220;
  --line: rgba(255,255,255,.12);
  --text:#EAF0FF; --muted: rgba(234,240,255,.70); --muted2: rgba(234,240,255,.50);
  --accent1:#6AA7FF; --accent2:#20C997;
  --warn:#FFC107; --danger:#FF6B6B;
  --shadow: 0 18px 55px rgba(0,0,0,.45);
  --radius: 18px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: Arial, sans-serif;
  color:var(--text);
  background:
    radial-gradient(1200px 700px at 15% 0%, rgba(106,167,255,.20), transparent 55%),
    radial-gradient(1000px 650px at 90% 18%, rgba(32,201,151,.16), transparent 55%),
    radial-gradient(900px 650px at 50% 120%, rgba(255,255,255,.06), transparent 55%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
  min-height:100vh;
}
.wrap{max-width:1180px;margin:0 auto;padding:22px}
.topbar{
  border:1px solid var(--line);
  background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  border-radius: 22px;
  padding: 16px 16px 12px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(8px);
}
.logos{
  display:grid;
  grid-template-columns: 1fr 1fr;
  align-items:center;
  gap:12px;
  margin-bottom:10px;
}
.logoBox{display:flex;align-items:center;justify-content:center}
.logoBox.left{justify-content:flex-start}
.logoBox.right{justify-content:flex-end}
.logoImg{height:56px;width:auto;object-fit:contain;filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));}
.brandText{text-align:center;line-height:1.6;margin-top:6px}
.brandText .l2{color:var(--text);font-weight:900;font-size:16px}
.brandText .l3{color:var(--muted);font-weight:900;font-size:14px}
.brandText .l4{color:var(--muted);font-weight:900;font-size:14px}
.brandText .title{margin-top:10px;font-weight:900;font-size:20px}
.brandText .subtitle{color:var(--muted);font-size:13px;margin-top:6px}

.steps{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
.pill{border:1px solid var(--line);background: rgba(255,255,255,.05);border-radius:999px;padding:8px 12px;font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px}
.dot{width:8px;height:8px;border-radius:50%;background: rgba(255,255,255,.18)}
.pill.active{color:var(--text);background: rgba(106,167,255,.14);border-color: rgba(106,167,255,.35)}
.pill.active .dot{background: var(--accent1)}

.card{margin-top:16px;border:1px solid var(--line);background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border-radius: var(--radius);padding:16px;box-shadow: var(--shadow);backdrop-filter: blur(8px);}
.screen{display:none}
.screen.active{display:block}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:820px){
  .grid2{grid-template-columns:1fr}
  .logos{grid-template-columns:1fr}
  .logoBox.left,.logoBox.right{justify-content:center}
}
label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
input[type="text"]{width:100%;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.18);background: rgba(0,0,0,.18);color:var(--text);outline:none;font-size:14px;font-family: Arial, sans-serif;}

.actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:14px}
button{border:1px solid rgba(255,255,255,.14);background: rgba(106,167,255,.16);color:var(--text);padding:11px 14px;border-radius:14px;cursor:pointer;font-weight:900;font-family: Arial, sans-serif;}
button:hover{background: rgba(106,167,255,.24)}
.secondary{background: rgba(255,255,255,.07)}
.secondary:hover{background: rgba(255,255,255,.12)}
.danger{background: rgba(255,107,107,.14)}
.danger:hover{background: rgba(255,107,107,.20)}
.note{color:var(--muted);font-size:12px;line-height:1.9;margin-top:10px}
.error{display:none;margin-top:12px;color:var(--danger);font-size:13px;line-height:1.7}

.inputsGrid{display:grid;grid-template-columns:1fr 170px 170px;gap:10px;align-items:center}
.head{color:var(--muted);font-size:12px;padding:8px 10px;border-bottom:1px solid var(--line)}
.cell{padding:10px;border:1px solid var(--line);border-radius:14px;background: rgba(0,0,0,.18);line-height:1.6;font-size:14px}
.centerTxt{display:flex;align-items:center;justify-content:center}
input[type="number"]{width:100%;padding:12px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background: rgba(255,255,255,.06);color: var(--text);outline:none;font-size:14px;text-align:center;font-family: Arial, sans-serif;}
@media (max-width:720px){
  .inputsGrid{grid-template-columns:1fr}
  .centerTxt{justify-content:flex-start}
  input[type="number"]{text-align:right}
}

.tableWrap{margin-top:12px;overflow:auto;border:1px solid var(--line);border-radius:18px;background: rgba(0,0,0,.18);}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px;table-layout:fixed;font-family: Arial, sans-serif;}
th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13.5px;line-height:1.65;vertical-align:middle}
th{position:sticky;top:0;background: rgba(255,255,255,.06);font-weight:900;z-index:2;text-align:center}
td.goal{font-weight:900;text-align:center;border-left:1px solid rgba(255,255,255,.08);padding:14px 10px}
td.res{text-align:right}
td.num{text-align:center;font-variant-numeric: tabular-nums;}
.goalBg1 td{background: linear-gradient(90deg, rgba(106,167,255,.10), rgba(255,255,255,0));}
.goalBg2 td{background: linear-gradient(90deg, rgba(32,201,151,.10), rgba(255,255,255,0));}
.goalBg3 td{background: linear-gradient(90deg, rgba(255,193,7,.10), rgba(255,255,255,0));}
tr:last-child td{border-bottom:none}

.badge{display:inline-flex;align-items:center;justify-content:center;padding:5px 12px;border-radius:999px;font-weight:900;font-size:12px;border:1px solid rgba(255,255,255,.18);white-space:nowrap}
.b-high{background:rgba(32,201,151,.18); color:#BFF5E5}
.b-exp{background:rgba(106,167,255,.18); color:#D7E6FF}
.b-low{background:rgba(255,193,7,.16); color:#FFE7A3}

.summaryCard{margin-top:12px;border:1px solid var(--line);border-radius:16px;background: rgba(255,255,255,.04);padding:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.summaryCard .k{color:var(--muted);font-size:12px}
.summaryCard .v{font-weight:900;font-size:16px;font-variant-numeric: tabular-nums}

.modalBack{display:none;position:fixed;inset:0;background: rgba(0,0,0,.55);z-index:50;padding:22px}
.modal{max-width:980px;margin:0 auto;border:1px solid rgba(255,255,255,.16);border-radius:18px;background: linear-gradient(180deg, rgba(15,20,35,.98), rgba(10,14,25,.98));box-shadow: var(--shadow);padding:14px}
.modalHead{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.modalHead .t{font-weight:900}
.modal table{min-width:860px}
.smallBtn{padding:8px 12px;border-radius:12px}

.footerBar{margin-top:16px;border-top:1px solid rgba(255,255,255,.10);padding-top:10px;display:flex;justify-content:space-between;gap:12px;font-size:12px;color:rgba(234,240,255,.60);flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="logos">
      </div>
    <div class="brandText">
      <div class="l2">المديرية العامة للتربية والتعليم بمحافظة ظفار</div>
<div class="title">استمارة التحويل الذكي لنتائج الزيارة الإشرافية</div>
      <div class="subtitle">تحويل بنود الزيارة الإشرافية إلى النتائج الرئيسية</div>
    </div>
    <div class="steps">
      <div class="pill" id="pill1"><span class="dot"></span>الدخول</div>
      <div class="pill" id="pill2"><span class="dot"></span>بيانات</div>
      <div class="pill" id="pill3"><span class="dot"></span>البنود</div>
      <div class="pill" id="pill4"><span class="dot"></span>النتائج</div>
    </div>
  </div>

  <div class="card screen active" id="screen1">
    <div style="font-weight:900;font-size:16px;margin-bottom:8px">بدء الاستخدام</div>
    <div class="note">أدخل متوسط البنود (1–13) ثم اعرض النتائج الرئيسية والتقدير النهائي للزيارة.</div>
    <div class="actions"><button id="btnEnter">دخول</button></div>
  </div>

  <div class="card screen" id="screen2">
    <div style="font-weight:900;font-size:16px;margin-bottom:10px">بيانات المعلم والمدرسة</div>
    <div class="grid2">
      <div><label>اسم المعلم</label><input id="teacherName" type="text" placeholder="مثال أحمد عبد الفتاح"></div>
      <div><label>اسم المدرسة</label><input id="schoolName" type="text" placeholder="مثال مدرسة يزيد بن الحارث"></div>
    </div>
    <div class="actions">
      <button class="secondary" id="back2">رجوع</button>
      <button id="next2">التالي</button>
    </div>
  </div>

  <div class="card screen" id="screen3">
    <div style="font-weight:900;font-size:16px;margin-bottom:10px">بنود الزيارة الإشرافية</div>
    <div class="inputsGrid" id="inputsGrid">
      <div class="head">البند</div>
      <div class="head" style="text-align:center">المتوسط (1–5)</div>
      <div class="head" style="text-align:center">الأداء الفعلي (محول)</div>
    </div>

    <div class="note">
      التحويل: 1 أو 2 ⟶ 4 ، 3 ⟶ 3 ، 4 ⟶ 2 ، 5 ⟶ 1. <br>
      التجميع: (3+4) ÷ 2 ، و (11+12) ÷ 2.
    </div>

    <div class="error" id="err"></div>

    <div class="actions">
      <button class="secondary" id="back3">رجوع</button>
      <button class="danger" id="reset3">مسح القيم</button>
      <button class="secondary" id="pdfForm">استخراج استمارة تحويل القيم (PDF)</button>
      <button id="toResults">النتائج الرئيسية</button>
    </div>
  </div>

  <div class="card screen" id="screen4">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:900;font-size:16px">النتائج الرئيسية</div>
        <div class="note" id="metaLine"></div>
      </div>
      <div class="actions" style="margin-top:0;justify-content:flex-start">
        <button class="secondary" id="back4">رجوع</button>
        <button class="secondary" id="tipsBtn">نصائح</button>
        <button id="pdfReport">استخراج تقرير PDF</button>
      </div>
    </div>

    <div class="summaryCard" id="finalSummary" style="display:none">
      <div>
        <div class="k">المتوسط النهائي للزيارة الإشرافية</div>
        <div class="v" id="finalAvg">—</div>
      </div>
      <div>
        <div class="k">التقدير النهائي</div>
        <div class="v" id="finalGrade">—</div>
      </div>
    </div>

    <div class="tableWrap">
      <table id="excelTable">
        <thead>
          <tr>
            <th style="width:22%">الهدف</th>
            <th>النتائج الرئيسية</th>
            <th style="width:12%">المتوسط</th>
            <th style="width:12%">الأداء الفعلي</th>
            <th style="width:12%">التقدير</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<div class="modalBack" id="tipsModal">
  <div class="modal">
    <div class="modalHead">
      <div class="t">نصائح إشرافية مختصرة حسب النتائج</div>
      <button class="secondary smallBtn" id="closeTips">إغلاق</button>
    </div>
    <div class="tableWrap">
      <table id="tipsTable">
        <thead>
          <tr>
            <th>النتيجة الرئيسية</th>
            <th style="width:14%">التقدير</th>
            <th>النصيحة</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const DIRECTORATE = "المديرية العامة للتربية والتعليم بمحافظة ظفار";
const SCHOOL1 = "";
const SCHOOL2 = "";
const TIPS = {"وضع خطط تدريس تحقق أهداف التعلم": "راجع نواتج التعلم وصُغ أهدافًا سلوكية دقيقة، ثم اربط كل هدف بنشاط وتقويم واضح داخل الدرس.", "توظيف المصادر والمنصات الملائمة": "نوّع المصادر (منصة، وسائط، موارد مدرسية) وحدد سبب اختيار كل مصدر بما يخدم الهدف والفروق الفردية.", "توظيف التقويم من أجل التعلم": "استخدم تقويمًا بنائيًا أثناء الدرس (أسئلة تشخيصية، بطاقات خروج، ملاحظة) مع تغذية راجعة فورية قابلة للتطبيق.", "تهيئة بيئة تعلمية جاذبة": "حسّن إدارة المكان والوقت، وفعّل قواعد صفية إيجابية، ووفّر أنشطة قصيرة تحفّز المشاركة والانضباط.", "تحقيق أداء تدريسي فاعل": "فعّل استراتيجيات نشطة (تعلم تعاوني/محطات/تفكير ناقد) مع توزيع أدوار واضح ومؤشرات متابعة.", "تحسين المستوى التحصيلي للطلبة بصورة مرضية": "حلّل نتائج الطلبة، وحدد فجوات التعلم، ثم نفّذ خطة علاجية قصيرة بأهداف أسبوعية قابلة للقياس.", "تحقيق التقدم الدراسي للطلبة بمرور الوقت": "تابع تقدّم الطلبة عبر مؤشرات دورية (خط أساس/متابعة/تحسّن) ووثّق الأدلة في ملفات تعلم أو سجلات.", "اكساب الطلبة مهارات التعلم وربطها بحياتهم": "صمّم مهام واقعية مرتبطة ببيئة الطالب، واطلب مخرجات تطبيقية (مشروع صغير/عرض/حل مشكلة).", "تحقيق الالتزام بزمن التعلم والإنجاز الدراسي بنسبة %90": "اضبط زمن الحصة، وقلّل الفاقد التعليمي، وثبّت روتين افتتاح/خاتمة يضمن إنهاء المهمات.", "تطوير الممارسات المهنية للتعلم المستمر بشكل مستمر": "حدد هدفًا مهنيًا شهريًا، نفّذ درسًا نموذجيًا أو تبادل زيارات، ووثّق أثر التطوير على تعلم الطلبة.", "تنفيذ مبادرات وأنشطة تربوية في المجتمع المدرسي بفعالية": "اختر مبادرة قابلة للتنفيذ، حدّد أدوار فريق العمل، وضع مؤشرات أثر (مشاركة/تحسن/سلوك) وفعّل الشراكة."};

const visitItems = [
  { id: 1, text: "تحصيل الطلبة في الأعمال الصفية وغير الصفية" },
  { id: 2, text: "التقدم الدراسي للطلبة بما فيهم الطلبة ذوي الإعاقة / الاحتياجات التعليمية" },
  { id: 3, text: "تطبيق مهارات التعلم (الذاتي – التعاوني – الرقمي – التفكير العليا) وربطها بالواقع" },
  { id: 4, text: "تمسك الطلبة بالهوية العُمانية والقيم الإنسانية" },
  { id: 5, text: "متابعة جوانب الأمن والسلامة والنظافة في بيئة التعلم" },
  { id: 6, text: "تخطيط المنهاج الدراسي لتحقيق نواتج التعلم" },
  { id: 7, text: "فاعلية الإدارة الصفية" },
  { id: 8, text: "توظيف استراتيجيات التدريس الفعالة" },
  { id: 9, text: "تفعيل المصادر والموارد التعليمية" },
  { id: 10, text: "توظيف أساليب تقويم متنوعة" },
  { id: 11, text: "توظيف التقويم الذاتي والتطوير المهني في تحسين الأداء" },
  { id: 12, text: "تطبيق السياسات والأنظمة واللوائح المنظمة للعمل" },
  { id: 13, text: "تنفيذ مبادرات وأنشطة تربوية في المجتمع المدرسي" },
];

const goals = [
  {
    name: "تجويد الأداء التدريسي في المواقف التعليمية",
    className: "goalBg1",
    results: [
      { name: "وضع خطط تدريس تحقق أهداف التعلم", sourceIds: [6] },
      { name: "توظيف المصادر والمنصات الملائمة", sourceIds: [9] },
      { name: "توظيف التقويم من أجل التعلم", sourceIds: [10] },
      { name: "تهيئة بيئة تعلمية جاذبة", sourceIds: [5] },
      { name: "تحقيق أداء تدريسي فاعل", sourceIds: [8] },
    ]
  },
  {
    name: "تحسين إنجاز الطلبة بشكل مستمر",
    className: "goalBg2",
    results: [
      { name: "تحسين المستوى التحصيلي للطلبة بصورة مرضية", sourceIds: [1] },
      { name: "تحقيق التقدم الدراسي للطلبة بمرور الوقت", sourceIds: [2] },
      { name: "اكساب الطلبة مهارات التعلم وربطها بحياتهم", sourceIds: [3,4], combine: "avg" },
    ]
  },
  {
    name: "تحقيق التنمية المهنية المستدامة",
    className: "goalBg3",
    results: [
      { name: "تحقيق الالتزام بزمن التعلم والإنجاز الدراسي بنسبة %90", sourceText: "%90" },
      { name: "تطوير الممارسات المهنية للتعلم المستمر بشكل مستمر", sourceIds: [11,12], combine: "avg" },
      { name: "تنفيذ مبادرات وأنشطة تربوية في المجتمع المدرسي بفعالية", sourceIds: [13] },
    ]
  }
];

function normalizeNumberInput(x){
  if (x === "" || x === null || x === undefined) return "";
  // دعم الأرقام العربية والفاصلة
  let s = String(x).trim()
    .replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d))
    .replace(/[۰-۹]/g, d => "۰۱۲۳۴۵۶۷۸۹".indexOf(d))
    .replace(/,/g, ".")
    .replace(/[^\d.]/g, "");
  // اسمح بنقطة واحدة فقط
  const parts = s.split(".");
  if (parts.length > 2) s = parts[0] + "." + parts.slice(1).join("");
  return s;
}

function isAllowedScore(n){
  if (!Number.isFinite(n)) return false;
  if (n < 1 || n > 5) return false;
  // منع رقمين أو أكثر قبل الفاصلة (مثل 11، 10، 99)
  if (Math.floor(n) >= 10) return false;
  // السماح فقط بخطوة 0.5 (1, 1.5, 2, 2.5 ... 5)
  const twice = Math.round(n * 2);
  if (Math.abs(n * 2 - twice) > 1e-9) return false;
  return true;
}

function convertToActual(x){
  const s = normalizeNumberInput(x);
  if (!s) return null;
  const n = Number(s);
  if (!isAllowedScore(n)) return null;

  // تحويل المتوسط إلى الأداء الفعلي حسب المطلوب:
  // 1.5 => 4 (عالي) | 2.5 => 3 (متوقع) | 3.5 => 3 (متوقع) | 4.5 => 2 (منخفض)
  if (n <= 2.33) return 4;   // عالي
  if (n <= 3.67) return 3;   // متوقع
  return 2;                  // منخفض
}

function gradeFromAverage(avg){
  if (avg === null || !Number.isFinite(avg)) return { label:"", cls:"" };
  if (avg <= 2.33) return { label:"عالي", cls:"b-high" };
  if (avg <= 3.67) return { label:"متوقع", cls:"b-exp" };
  return { label:"منخفض", cls:"b-low" };
}

function avg(arr){
  const xs = arr.filter(v => v !== null && Number.isFinite(v));
  if(xs.length === 0) return null;
  return xs.reduce((a,b)=>a+b,0)/xs.length;
}

function fmt(x){
  if(x === null) return "—";
  const r = Math.round(x*100)/100;
  return (r % 1 === 0) ? String(r.toFixed(0)) : String(r.toFixed(2)).replace(/0+$/,'').replace(/\.$/,'');
}

const screens = [1,2,3,4].map(i => document.getElementById("screen"+i));
const pills = [1,2,3,4].map(i => document.getElementById("pill"+i));
function go(step){
  screens.forEach((s,idx)=>s.classList.toggle("active", idx===step-1));
  pills.forEach((p,idx)=>p.classList.toggle("active", idx===step-1));
  window.scrollTo({top:0,behavior:"smooth"});
}

const inputsGrid = document.getElementById("inputsGrid");
function makeRow(item){
  const c1 = document.createElement("div");
  c1.className = "cell";
  c1.innerHTML = `<strong>${item.id}.</strong> ${item.text}`;

  const c2 = document.createElement("div");
  c2.className = "cell centerTxt";
  const inp = document.createElement("input");
  inp.type="number"; inp.min="1"; inp.max="5"; inp.step="0.5";
  inp.placeholder="مثال: 2 أو 3.5";
  inp.dataset.id = String(item.id);
  c2.appendChild(inp);

  const c3 = document.createElement("div");
  c3.className = "cell centerTxt";
  c3.id = `actual_${item.id}`;
  c3.style.color = "var(--muted2)";
  c3.textContent = "—";

  inp.addEventListener("input", ()=>{
    const cleaned = normalizeNumberInput(inp.value);
    if (cleaned !== inp.value) inp.value = cleaned;

    if (inp.value === "") {
      c3.textContent = "—";
      c3.style.color = "var(--muted2)";
      return;
    }

    const n = Number(inp.value);
    if (!isAllowedScore(n)) {
      inp.value = "";
      c3.textContent = "—";
      c3.style.color = "var(--muted2)";
      return;
    }

    const actual = convertToActual(n);
    c3.textContent = String(actual);
    c3.style.color = "var(--text)";
  });

  inputsGrid.appendChild(c1);
  inputsGrid.appendChild(c2);
  inputsGrid.appendChild(c3);
}
visitItems.forEach(makeRow);

function getValue(id){
  const el = document.querySelector(`input[data-id="${id}"]`);
  if(!el) return null;
  if(el.value==="") return null;
  const n = Number(el.value);
  return Number.isFinite(n) ? n : null;
}

function resetInputs(){
  document.querySelectorAll('input[type="number"]').forEach(i=>i.value="");
  visitItems.forEach(it=>{
    const out = document.getElementById(`actual_${it.id}`);
    out.textContent="—";
    out.style.color="var(--muted2)";
  });
}

const err = document.getElementById("err");
const tbody = document.querySelector("#excelTable tbody");
const metaLine = document.getElementById("metaLine");

const finalSummary = document.getElementById("finalSummary");
const finalAvgEl = document.getElementById("finalAvg");
const finalGradeEl = document.getElementById("finalGrade");

let lastComputed = null;

function computeAll(){
  const missing = [];
  for(const it of visitItems){
    const v = getValue(it.id);
    if(v === null) missing.push(it.id);
  }
  if(missing.length){
    return { ok:false, msg:`لازم تعبي درجات كل البنود قبل المتابعة. البنود الناقصة: ${missing.join(", ")}` };
  }

  const tName = (document.getElementById("teacherName").value || "").trim();
  const sName = (document.getElementById("schoolName").value || "مدرسة ").trim();

  const rows = [];
  const tipsRows = [];
  const finalAverages = [];

  for(const goal of goals){
    for(const r of goal.results){
      let rawAvg = null;
      let actualAvg = null;
      let grade = {label:"—", cls:""};

      if(r.sourceText){
        rows.push({goal: goal.name, goalClass: goal.className, res: r.name, raw: r.sourceText, actual: null, grade: null});
        tipsRows.push({res:r.name, grade:"—", tip: TIPS[r.name] || "—"});
      } else {
        const rawValues = r.sourceIds.map(getValue);
        rawAvg = avg(rawValues);
        const actualValues = rawValues.map(convertToActual);
        actualAvg = avg(actualValues);
        grade = gradeFromAverage(rawAvg);
        rows.push({goal: goal.name, goalClass: goal.className, res: r.name, raw: rawAvg, actual: actualAvg, grade });
        tipsRows.push({res:r.name, grade: grade.label || "—", tip: TIPS[r.name] || "—"});
        finalAverages.push(rawAvg);
      }
    }
  }

  const overallAvg = avg(finalAverages);
  const overallGrade = gradeFromAverage(overallAvg);

  return {
    ok:true,
    teacher: tName || "—",
    school: sName,
    rows,
    tipsRows,
    overallAvg,
    overallGrade: overallGrade.label || "—"
  };
}

function renderResults(calc){
  tbody.innerHTML="";
  const grouped = {};
  calc.rows.forEach(r=>{ (grouped[r.goal] ||= []).push(r); });

  Object.entries(grouped).forEach(([goalName, items])=>{
    items.forEach((it, idx)=>{
      const tr = document.createElement("tr");
      tr.className = it.goalClass;

      const goalTd = (idx===0)
        ? `<td class="goal" rowspan="${items.length}">${goalName}</td>`
        : "";

      const gradeCell = it.grade
        ? `<span class="badge ${it.grade.cls}">${it.grade.label}</span>`
        : "—";

      tr.innerHTML = `
        ${goalTd}
        <td class="res">${it.res}</td>
        <td class="num">${(typeof it.raw === "string") ? it.raw : fmt(it.raw)}</td>
        <td class="num">${it.actual===null ? "—" : fmt(it.actual)}</td>
        <td class="num">${it.grade ? gradeCell : "—"}</td>
      `;
      tbody.appendChild(tr);
    });
  });

  metaLine.textContent = `المعلم: ${calc.teacher} | المدرسة: ${calc.school}`;

  finalSummary.style.display="flex";
  finalAvgEl.textContent = fmt(calc.overallAvg);
  finalGradeEl.innerHTML = calc.overallGrade === "عالي"
    ? `<span class="badge b-high">عالي</span>`
    : (calc.overallGrade === "متوقع"
        ? `<span class="badge b-exp">متوقع</span>`
        : `<span class="badge b-low">منخفض</span>`);
}

function buildResults(){
  err.style.display="none"; err.textContent="";
  const calc = computeAll();
  if(!calc.ok){
    err.style.display="block";
    err.textContent = calc.msg;
    return false;
  }
  lastComputed = calc;
  renderResults(calc);
  return true;
}

function renderTips(){
  if(!lastComputed) return;
  const tb = document.querySelector("#tipsTable tbody");
  tb.innerHTML="";
  lastComputed.tipsRows.forEach(r=>{
    const tr = document.createElement("tr");
    const badge = r.grade==="عالي"
      ? `<span class="badge b-high">عالي</span>`
      : (r.grade==="متوقع"
          ? `<span class="badge b-exp">متوقع</span>`
          : (r.grade==="منخفض" ? `<span class="badge b-low">منخفض</span>` : "—"));
    tr.innerHTML = `
      <td class="res">${r.res}</td>
      <td class="num">${badge}</td>
      <td class="res">${r.tip}</td>
    `;
    tb.appendChild(tr);
  });
}

function openPrintWindow(kind){
  if(!lastComputed) return;

  const css = `
    body{font-family: Arial, sans-serif; direction: rtl; margin: 26px; color:#111}
    .hdr{text-align:center; margin-bottom:14px}
    .hdr .l2{font-weight:900; font-size:15px}
    .hdr .l3{font-weight:900; font-size:13px; margin-top:4px}
    .hdr .l4{font-weight:900; font-size:13px; margin-top:2px}
    .hdr .t{font-weight:900; font-size:16px; margin-top:10px}
    .meta{margin: 10px 0 14px; font-size:12px}
    table{width:100%; border-collapse:collapse; table-layout:fixed}
    th,td{border:1px solid #bbb; padding:8px; font-size:12px; vertical-align:middle}
    th{background:#f2f2f2; font-weight:900; text-align:center}
    td.res{text-align:right}
    td.num{text-align:center; font-variant-numeric: tabular-nums;}
    .sign{margin-top:18px; font-size:12px; text-align:center; font-weight:900}
    .goalCell{font-weight:900; text-align:center; background:#fafafa}
    @media print { @page { size: A4; margin: 16mm; } }
  `;

  const w = window.open("", "_blank");
  const tName = lastComputed.teacher;
  const sName = lastComputed.school;

  let bodyHtml = "";

  if(kind === "form"){
    const rows = visitItems.map(it=>{
      const raw = getValue(it.id);
      const actual = convertToActual(raw);
      return `<tr>
        <td class="res">${it.id}. ${it.text}</td>
        <td class="num">${fmt(raw)}</td>
        <td class="num">${actual===null ? "—" : actual}</td>
      </tr>`;
    }).join("");

    bodyHtml = `
      <div class="hdr">
        <div class="l2">${DIRECTORATE}</div>
        <div class="l3">${SCHOOL1}</div>
        <div class="l4">${SCHOOL2}</div>
        <div class="t">استمارة تحويل القيم – الزيارة الإشرافية</div>
      </div>
      <div class="meta">المعلم: ${tName} | المدرسة: ${sName} | تاريخ الاستخراج: ${new Date().toLocaleDateString('ar')}</div>
      <table>
        <thead>
          <tr>
            <th>البند</th>
            <th style="width:16%">المتوسط</th>
            <th style="width:18%">الأداء الفعلي</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="sign">يعتمد مدير المدرسة</div>
    `;
  } else {
    const grouped = {};
    lastComputed.rows.forEach(r=>{ (grouped[r.goal] ||= []).push(r); });

    const trs = Object.entries(grouped).map(([g, items])=>{
      return items.map((it, idx)=>{
        const goalTd = idx===0 ? `<td class="goalCell" rowspan="${items.length}">${g}</td>` : "";
        const raw = (typeof it.raw === "string") ? it.raw : fmt(it.raw);
        const actual = it.actual===null ? "—" : fmt(it.actual);
        const grade = it.grade ? it.grade.label : "—";
        return `<tr>
          ${goalTd}
          <td class="res">${it.res}</td>
          <td class="num">${raw}</td>
          <td class="num">${actual}</td>
          <td class="num">${grade}</td>
        </tr>`;
      }).join("");
    }).join("");

    bodyHtml = `
      <div class="hdr">
        <div class="l2">${DIRECTORATE}</div>
        <div class="l3">${SCHOOL1}</div>
        <div class="l4">${SCHOOL2}</div>
        <div class="t">تقرير نتائج الزيارة الإشرافية</div>
      </div>
      <div class="meta">المعلم: ${tName} | المدرسة: ${sName} | تاريخ الاستخراج: ${new Date().toLocaleDateString('ar')}</div>
      <table>
        <thead>
          <tr>
            <th style="width:22%">الهدف</th>
            <th>النتائج الرئيسية</th>
            <th style="width:12%">المتوسط</th>
            <th style="width:12%">الأداء الفعلي</th>
            <th style="width:12%">التقدير</th>
          </tr>
        </thead>
        <tbody>${trs}</tbody>
      </table>
      <div class="meta" style="margin-top:10px;font-weight:900">
        التقدير النهائي للزيارة الإشرافية: ${lastComputed.overallGrade} | المتوسط النهائي: ${fmt(lastComputed.overallAvg)}
      </div>
      <div class="sign">يعتمد مدير المدرسة</div>
    `;
  }

  w.document.open();
  w.document.write(`<html lang="ar" dir="rtl"><head><meta charset="utf-8"/><title>PDF</title><style>${css}</style></head><body>${bodyHtml}<script>window.onload=function(){window.print();};<\/script></body></html>`);
  w.document.close();
}

document.getElementById("btnEnter").addEventListener("click", ()=>go(2));
document.getElementById("back2").addEventListener("click", ()=>go(1));
document.getElementById("next2").addEventListener("click", ()=>go(3));
document.getElementById("back3").addEventListener("click", ()=>go(2));
document.getElementById("reset3").addEventListener("click", resetInputs);
document.getElementById("toResults").addEventListener("click", ()=>{ if(buildResults()) go(4); });
document.getElementById("back4").addEventListener("click", ()=>go(3));
document.getElementById("pdfForm").addEventListener("click", ()=>{
  const calc = computeAll();
  if(!calc.ok){ err.style.display="block"; err.textContent = calc.msg; return; }
  lastComputed = calc;
  openPrintWindow("form");
});
document.getElementById("pdfReport").addEventListener("click", ()=>{ if(lastComputed) openPrintWindow("report"); });

const tipsModal = document.getElementById("tipsModal");
document.getElementById("tipsBtn").addEventListener("click", ()=>{ renderTips(); tipsModal.style.display="block"; });
document.getElementById("closeTips").addEventListener("click", ()=>tipsModal.style.display="none");
tipsModal.addEventListener("click", (e)=>{ if(e.target===tipsModal) tipsModal.style.display="none"; });

go(1);
</script>
</body>
</html>
